<!-- TOC -->

- [1. 正交投影](#1-正交投影)
- [2. 投影纹理坐标](#2-投影纹理坐标)
- [3. 阴影贴图](#3-阴影贴图)
  - [3.1. 走样与偏移](#31-走样与偏移)
  - [3.2. PCF(Percentage Closer Filter)](#32-pcfpercentage-closer-filter)
    - [3.2.1. PCF 核太大的问题](#321-pcf-核太大的问题)
  - [3.3. 阴影因子](#33-阴影因子)

<!-- /TOC -->

# 1. 正交投影
- 不需要齐次除法

# 2. 投影纹理坐标
用于阴影贴图采样。

work flow:
- 将点投影至光源的投影窗口，并将其坐标变换到NDC空间
- 将投影坐标从NDC空间变换到纹理空间，并将他们转换为纹理坐标

# 3. 阴影贴图
原理：
阴影贴图只存当前光源坐标系下最近的像素深度值。
 
两个深度的比较都是在NDC空间
- 通过投影到阴影贴图的NDC空间内得到当前点的深度
- 通过阴影贴图直接获取当前方向最近的深度

## 3.1. 走样与偏移
原因：
- 阴影图精度不够

处理方案：
- 比较的时候加偏移：
    - 斜率缩放偏移： 根据斜率加偏移量。通过PipelineStateDesc.RasterizerState来设置。

## 3.2. PCF(Percentage Closer Filter)
类似于纹理过滤：通常的采样不会准确命中阴影纹理中纹素的准确位置，通常位于4个纹素之间。对这4个纹素进行采样，然后进行双线性插值获得最后的纹素值。

但是纹理采样消耗太大，采用下列方式进行优化：
- SampleCMPLevelZero

### 3.2.1. PCF 核太大的问题
核太大，比较的时候还是用的中心点的深度值与各采样点的值进行比较，虽然会获得比较好的软阴影效果，但是有时候会导致比较大的阴影误差。

解决方案：
- 根据UV平面的偏移通过ddx和ddy的方式计算得到各采样点对应的深度值与采样点的深度值进行比较，而不仅仅是使用中心店的深度值。实际计算分两种：
  - $z = f(x,y)$的形式
  - $z = f(u,v)$的形式

## 3.3. 阴影因子
通过PCF中相邻点的比例，来判断阴影因子的大小。

